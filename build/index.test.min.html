<!DOCTYPE html>
<html lang="fr">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>ESP32 Server</title>
 <style>
 :root { --cd:#3B82F6; --ca:#EC4899; --ci:#10B981; --cu:#6B7280; --cs:#8B5CF6; --cp:#EF4444; --cg:#000; --bg:#f9fafb; --bd:#e5e7eb; --tx:#374151; --mt:#6b7280; }
 *{margin:0;padding:0;box-sizing:border-box}
 body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f3f4f6;color:#111827}
 .c{max-width:1200px;margin:0 auto;padding:20px}
 .h{text-align:center;margin-bottom:30px}.h h1{color:#1f2937;margin-bottom:10px}.h p{color:#6b7280}
 .t{display:flex;background:#fff;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,.1);margin-bottom:20px}
 .tab{flex:1;padding:15px;text-align:center;cursor:pointer;border-bottom:3px solid transparent;transition:all .2s}
 .tab.active{border-bottom-color:var(--cd);color:var(--cd);font-weight:600}
 .tab:hover:not(.active){background:var(--bg)}
 .p{display:none;background:#fff;border-radius:8px;padding:25px;box-shadow:0 1px 3px rgba(0,0,0,.1)}.p.active{display:block}
 .f{margin-bottom:20px}.f label{display:block;margin-bottom:8px;font-weight:500;color:var(--tx)}
 .f input,.f select{width:100%;padding:12px;border:1px solid #d1d5db;border-radius:6px;font-size:14px}
 .f input:focus,.f select:focus{outline:none;border-color:var(--cd);box-shadow:0 0 0 3px rgba(59,130,246,.1)}
 .btn{background:var(--cd);color:#fff;border:none;padding:12px 24px;border-radius:6px;cursor:pointer;font-size:14px;font-weight:500;transition:background .2s}
 .btn:hover{background:#2563eb}.btn:disabled{background:#9ca3af;cursor:not-allowed}
 .hint{margin-top:10px;color:var(--mt);font-size:14px}
 .g{display:grid;grid-template-columns:1fr 1fr;gap:20px}.card{background:#f8fafc;border:1px solid #e2e8f0;border-radius:6px;padding:15px}
 .card h3{color:#1f2937;margin-bottom:10px;font-size:16px}.card p{color:var(--mt);font-size:14px;margin-bottom:5px}
 .pl{display:flex;gap:20px;align-items:flex-start}.lp{flex:0 0 30%;min-width:300px}.rp{flex:1 1 auto}
 .cp{background:#fff;border:1px solid var(--bd);border-radius:8px;padding:16px}.cp h4{margin:6px 0 10px;font-size:15px;color:#1f2937}
 .r{display:flex;gap:12px;align-items:center;margin:8px 0;flex-wrap:wrap}.r label{color:var(--tx);font-size:14px}
 .b{width:100%;height:240px;border:1px solid var(--bd);border-radius:8px;background:var(--bg)}
 .l{display:flex;gap:14px;align-items:center;margin:10px 0 8px;flex-wrap:wrap}.s{width:14px;height:14px;border-radius:3px;display:inline-block;margin-right:6px}
 .s.digital{background:var(--cd)}.s.analog{background:var(--ca)}.s.i2c{background:var(--ci)}.s.uart{background:var(--cu)}.s.spi{background:var(--cs)}.s.power{background:var(--cp)}.s.gnd{background:var(--cg)}
 .plist{margin-top:20px;padding:15px;background:var(--bg);border-radius:8px}.plist h4{margin:0 0 10px;font-size:15px;color:var(--tx)}
 .list{display:flex;flex-direction:column;gap:4px}
 .item{display:flex;align-items:center;padding:8px 12px;background:#fff;border-radius:6px;border-left:4px solid var(--bd);cursor:pointer;transition:all .2s}
 .item:hover{background:var(--bg)}.item.analog{border-left-color:var(--ca)}.item.digital{border-left-color:var(--cd)}.item.i2c{border-left-color:var(--ci)}.item.spi{border-left-color:var(--cs)}.item.uart{border-left-color:var(--cu)}
 .lbl{font-weight:700;min-width:40px;margin-right:12px}.role{flex:1;color:var(--tx)}.stat{font-size:.9em;color:var(--mt)}
 .btn-p{width:100%;margin-top:15px;padding:12px;background:var(--cd);color:#fff;border:none;border-radius:6px;font-weight:700;cursor:pointer}
 .btn-p:hover{background:#2563eb}
 </style>
 <script>
 
 const $=s=>document.querySelector(s[0]=='#'?s:'#'+s);
 
 const pcfg={}; let cur=''; let caps=null; const prect={};
 
 function initTabs(){ document.querySelectorAll('.tab').forEach(t=>{ t.onclick=()=>{ document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); document.querySelectorAll('.p').forEach(p=>p.classList.remove('active')); t.classList.add('active'); $(`panel-${t.dataset.t}`).classList.add('active'); }; }); }
 
 async function loadStatus(){ const r=await fetch('/api/status'); const d=await r.json(); $('#apSsid').textContent=d.ap_ssid; $('#apIp').textContent=d.ap_ip; $('#staSsid').textContent=d.sta_ssid; $('#staIp').textContent=d.sta_ip; const s=$('#staStatus'); s.textContent=d.sta_connected?'Connecté':'Déconnecté'; s.style.color=d.sta_connected?'#059669':'#dc2626'; }
 
 async function loadMdns(){ const r=await fetch('/api/mdns/status'); const d=await r.json(); $('#mdnsName').value=d.name; }
 
 async function loadCaps(){ const r=await fetch('/api/pins/caps'); caps=await r.json(); drawBoard(); }
 
 const FC={DIGITAL:'#3B82F6',ANALOG:'#EC4899',I2C:'#10B981',UART:'#6B7280',SPI:'#8B5CF6',POWER:'#EF4444',GND:'#000'};
 const LAY=[{name:'5V',side:'right',row:0,type:'POWER',clickable:false},{name:'GND',side:'right',row:1,type:'GND',clickable:false},{name:'3V3',side:'right',row:2,type:'POWER',clickable:false},{name:'D0',side:'left',row:0,type:'ANALOG',typeLabel:'A0'},{name:'D1',side:'left',row:1,type:'ANALOG',typeLabel:'A1'},{name:'D2',side:'left',row:2,type:'ANALOG',typeLabel:'A2'},{name:'D3',side:'left',row:3,type:'ANALOG',typeLabel:'A3'},{name:'D4',side:'left',row:4,type:'I2C',typeLabel:'SDA'},{name:'D5',side:'left',row:5,type:'I2C',typeLabel:'SCL'},{name:'D6',side:'left',row:6,type:'UART',typeLabel:'TX'},{name:'D10',side:'right',row:3,type:'SPI',typeLabel:'MOSI'},{name:'D9',side:'right',row:4,type:'SPI',typeLabel:'MISO'},{name:'D8',side:'right',row:5,type:'SPI',typeLabel:'SCK'},{name:'D7',side:'right',row:6,type:'UART',typeLabel:'RX'}];
 function drawBoard(){ const L=$('#pinsLeft'),R=$('#pinsRight'); if(!L||!R)return; L.innerHTML=''; R.innerHTML=''; const RH=28; const COL={c1:20,c2:68,c4:238,c5:286}; const W=44,H=20;
 const mk=(x,y,w,h,fill,stroke,label,clk=true)=>{ const g=document.createElementNS('http://www.w3.org/2000/svg','g'); const r=document.createElementNS('http://www.w3.org/2000/svg','rect'); r.setAttribute('x',x); r.setAttribute('y',y); r.setAttribute('width',w); r.setAttribute('height',h); r.setAttribute('rx','4'); r.setAttribute('fill',fill); r.setAttribute('stroke',stroke); g.appendChild(r); const t=document.createElementNS('http://www.w3.org/2000/svg','text'); t.setAttribute('x',x+w/2); t.setAttribute('y',y+h/2+1); t.setAttribute('text-anchor','middle'); t.setAttribute('class','square-text'); t.textContent=label; g.appendChild(t); if(clk){ g.style.cursor='pointer'; r.dataset.label=label; prect[label]=r; r.addEventListener('click',()=>{ if(cur){ pcfg[cur]=readCfg(); } cur=label; $('#selPin').textContent=label; if(pcfg[cur]) applyCfg(pcfg[cur]); updatePinsList(); }); } return g; };
 const left=(row,tl,tc,dl)=>{ const y=30+row*RH; const f=document.createDocumentFragment(); f.appendChild(mk(COL.c1,y-10,W,H,tc,'#9ca3af',tl,false)); f.appendChild(mk(COL.c2,y-10,W,H,FC.DIGITAL,'#9ca3af',dl)); L.appendChild(f); };
 const rightPow=(row,label,color)=>{ const y=30+row*RH; R.appendChild(mk(COL.c4,y-10,W,H,color,'#9ca3af',label,false)); };
 const right=(row,dl,tl,tc)=>{ const y=30+row*RH; const f=document.createDocumentFragment(); f.appendChild(mk(COL.c4,y-10,W,H,FC.DIGITAL,'#9ca3af',dl)); f.appendChild(mk(COL.c5,y-10,W,H,tc,'#9ca3af',tl)); R.appendChild(f); };
 left(0,'A0',FC.ANALOG,'D0'); left(1,'A1',FC.ANALOG,'D1'); left(2,'A2',FC.ANALOG,'D2'); left(3,'A3',FC.ANALOG,'D3'); left(4,'SDA',FC.I2C,'D4'); left(5,'SCL',FC.I2C,'D5'); left(6,'TX',FC.UART,'D6'); rightPow(0,'5V',FC.POWER); rightPow(1,'GND',FC.GND); rightPow(2,'3V3',FC.POWER); right(3,'D10','MOSI',FC.SPI); right(4,'D9','MISO',FC.SPI); right(5,'D8','SCK',FC.SPI); right(6,'D7','RX',FC.UART);
 }
 
 function pType(lbl){ if(lbl.startsWith('A')||['D0','D1','D2','D3'].includes(lbl)) return 'analog'; if(['SDA','SCL'].includes(lbl)) return 'i2c'; if(['MOSI','MISO','SCK'].includes(lbl)) return 'spi'; if(['TX','RX'].includes(lbl)) return 'uart'; return 'digital'; }
 function stat(cfg){ if(cfg.role==='Potentiomètre'&&cfg.rtpEnabled) return `CC#${cfg.rtpCc||7}`; if(cfg.role==='Bouton'&&cfg.rtpEnabled) return `Note ${cfg.rtpNote||60}`; if(cfg.role==='LED') return 'Sortie'; return cfg.role||''; }
 function updatePinsList(){ const pl=$('#pinsList'); if(!pl) return; pl.innerHTML=''; Object.keys(pcfg).forEach(lbl=>{ const cfg=pcfg[lbl]; if(!cfg||!cfg.role) return; const it=document.createElement('div'); it.className=`item ${pType(lbl)}`; it.innerHTML=`<span class="lbl">${lbl}</span><span class="role">${cfg.role}</span><span class="stat">${stat(cfg)}</span>`; it.onclick=()=>{ const r=prect[lbl]; if(r) r.dispatchEvent(new Event('click')); }; pl.appendChild(it); }); }
 
 function readCfg(){ const c={}; c.role=$('#funcSelect')?.value||''; c.rtpEnabled=!!$('#rtpEnabled2')?.checked; c.rtpType=$('#rtpMsgType')?.value||''; c.rtpNote=$('#rtpNote')?.value||''; c.rtpCc=$('#rtpCc')?.value||''; c.rtpChan=$('#rtpChan')?.value||''; return c; }
 function applyCfg(c){ if(!c) return; const setV=(id,v)=>{ const el=$(id); if(el&&v!=null) el.value=v; }; const setC=(id,b)=>{ const el=$(id); if(el) el.checked=!!b; }; setV('funcSelect',c.role); setC('rtpEnabled2',c.rtpEnabled); setV('rtpMsgType',c.rtpType); setV('rtpNote',c.rtpNote); setV('rtpCc',c.rtpCc); setV('rtpChan',c.rtpChan); }
 
 async function saveAll(){ const msg=$('#saveAllMsg'); msg.textContent='Enregistrement...'; try{ const ps=Object.keys(pcfg).map(async lbl=>{ const c=pcfg[lbl]; if(!c||!c.role) return; const p=new URLSearchParams(); p.set('pinLabel',lbl); p.set('role',c.role); if(c.rtpEnabled) p.set('rtpEnabled','true'); if(c.rtpType) p.set('rtpType',c.rtpType); if(c.rtpNote) p.set('rtpNote',c.rtpNote); if(c.rtpCc) p.set('rtpCc',c.rtpCc); if(c.rtpChan) p.set('rtpChan',c.rtpChan); return fetch('/api/pins/set',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:p.toString()}); }); await Promise.all(ps); msg.textContent='Toutes les configurations enregistrées'; msg.style.color='#10b981'; }catch(e){ msg.textContent='Erreur lors de l\'enregistrement'; msg.style.color='#ef4444'; } }
 
 window.addEventListener('load',()=>{ initTabs(); loadStatus(); loadMdns(); loadCaps(); const btn=$('#saveAllBtn'); if(btn) btn.onclick=saveAll; });
 </script>
</head>
<body>
 <div class="c">
 <div class="h">
 <h1>ESP32 Server</h1>
 <p>Configuration Wi‑Fi, RTP‑MIDI et OSC</p>
 </div>
 <div class="t">
 <div class="tab active" data-t="status">Statut</div>
 <div class="tab" data-t="connection">Connection</div>
 <div class="tab" data-t="pins">Pins</div>
 </div>
 <div class="p active" id="panel-status">
 <div class="g">
 <div class="card"><h3>Access Point</h3><p><strong>SSID:</strong> <span id="apSsid">-</span></p><p><strong>IP:</strong> <span id="apIp">-</span></p></div>
 <div class="card"><h3>Station Wi‑Fi</h3><p><strong>SSID:</strong> <span id="staSsid">-</span></p><p><strong>IP:</strong> <span id="staIp">-</span></p><p><strong>Statut:</strong> <span id="staStatus">-</span></p></div>
 </div>
 </div>
 <div class="p" id="panel-connection">
 <div class="f"><h3>Serveur</h3><form id="mdns"><div class="f"><label for="mdnsName">Nom du serveur</label><input type="text" id="mdnsName" placeholder="esp32rtpmidi" required><div class="hint"><small>Ce nom sera utilisé pour l'AP Wi‑Fi et http://nom.local</small></div></div><button type="submit" class="btn">Enregistrer</button><div class="hint" id="mdnsMsg"></div></form></div>
 <div class="f"><h3>OSC</h3><form id="osc"><div class="f"><label for="oscTarget">Destination</label><select id="oscTarget"><option value="ap">AP (192.168.4.1)</option><option value="sta" id="oscStaOption">STA</option></select></div><div class="f"><label for="oscPort">Port</label><input type="number" id="oscPort" value="8000" min="1024" max="65535" required></div><button type="submit" class="btn">Enregistrer</button><div class="hint" id="oscMsg"></div></form></div>
 <div class="f"><h3>Wi‑Fi Station</h3><form id="sta"><div class="f"><label for="ssid">SSID</label><input type="text" id="ssid" placeholder="Nom du réseau" required></div><div class="f"><label for="pass">Mot de passe</label><input type="password" id="pass" placeholder="Mot de passe"></div><button type="submit" class="btn">Connecter</button><div class="hint" id="staMsg"></div></form></div>
 </div>
 <div class="p" id="panel-pins">
 <div class="pl">
 <div class="lp">
 <h3 id="boardName">ESP32‑C3</h3>
 <div class="l"><span class="s digital"></span> Digital <span class="s analog"></span> Analog <span class="s i2c"></span> I2C <span class="s uart"></span> UART <span class="s spi"></span> SPI <span class="s power"></span> Power <span class="s gnd"></span> GND</div>
 <svg class="b" viewBox="50 -20 260 260">
 <rect x="114" y="20" width="122" height="188" rx="10" fill="#ffffff" stroke="#9ca3af"/>
 <text x="174" y="114" text-anchor="middle" font-size="12" fill="#6b7280">MCU</text>
 <rect x="144" y="2" width="60" height="60" rx="6" fill="#e5e7eb" stroke="#9ca3af"/>
 <g id="pinsLeft"></g><g id="pinsRight"></g>
 </svg>
 <div class="plist"><h4>Pins configurées</h4><div id="pinsList" class="list"></div><button id="saveAllBtn" class="btn-p">Enregistrer tout</button><div id="saveAllMsg" class="hint"></div></div>
 </div>
 <div class="rp"><div class="cp">
 <h4>Fonction du pin</h4>
 <div class="r"><label>Pin:</label><span id="selPin">-</span><select id="funcSelect"><option>Digital</option><option>Analog</option><option>I2C</option><option>UART</option><option>SPI</option></select></div>
 <h4>RTP‑MIDI</h4>
 <div class="r"><input type="checkbox" id="rtpEnabled2"><label for="rtpEnabled2">Activer</label><label>Type:</label><select id="rtpMsgType"><option>Note</option><option>Control Change</option><option>Program Change</option><option>Pitch Bend</option></select></div>
 <div class="r"><label>Note:</label><input type="number" id="rtpNote" min="0" max="127" placeholder="60" style="width:90px;"><label>CC#:</label><input type="number" id="rtpCc" min="0" max="127" placeholder="7" style="width:90px;"><label>Ch:</label><input type="number" id="rtpChan" min="1" max="16" placeholder="1" style="width:90px;"></div>
 </div></div>
 </div>
 </div>
 </div>
</body>
</html>


